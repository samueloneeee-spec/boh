<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Punchball Score</title>
  <style>
    body {
      background: linear-gradient(to bottom, #111, #333);
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 20px;
      font-size: 2rem;
      color: #ff4444;
    }
    #video {
      margin-top: 20px;
      width: 320px;
      height: 240px;
      border: 3px solid #fff;
      border-radius: 12px;
      cursor: crosshair;
    }
    #score, #record {
      font-size: 2rem;
      margin: 20px;
    }
    button {
      background: #ff4444;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 1.2rem;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: #ff6666;
    }
    canvas { display: none; }
    #area-msg { margin-top: 10px; font-size: 1rem; color: #aaa; }
  </style>
</head>
<body>
  <h1>Punchball Simulator</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240"></canvas>

  <div id="area-msg">Disegna l’area del punchball cliccando e trascinando sul video</div>
  <div id="score">Punteggio: 0</div>
  <div id="record">Record: 0</div>
  <button id="reset">Gioca ancora</button>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const recordEl = document.getElementById('record');
    const resetBtn = document.getElementById('reset');
    const areaMsg = document.getElementById('area-msg');

    let lastFrame = null;
    let locked = false;
    let record = localStorage.getItem('record') || 0;
    recordEl.textContent = "Record: " + record;

    let punchArea = null; // area selezionata dal mouse

    // Attiva fotocamera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        alert("Errore accesso fotocamera: " + err);
      });

    // Disegno area con mouse
    let startX, startY;
    video.addEventListener("mousedown", (e) => {
      const rect = video.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
    });

    video.addEventListener("mouseup", (e) => {
      const rect = video.getBoundingClientRect();
      const endX = e.clientX - rect.left;
      const endY = e.clientY - rect.top;
      punchArea = {
        x: Math.min(startX, endX) * (canvas.width / video.clientWidth),
        y: Math.min(startY, endY) * (canvas.height / video.clientHeight),
        w: Math.abs(endX - startX) * (canvas.width / video.clientWidth),
        h: Math.abs(endY - startY) * (canvas.height / video.clientHeight)
      };
      areaMsg.textContent = "Area del punchball registrata!";
    });

    function detectMovement() {
      if (!punchArea) {
        requestAnimationFrame(detectMovement);
        return;
      }
      if (locked) {
        requestAnimationFrame(detectMovement);
        return;
      }

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

      if (lastFrame) {
        let diff = 0;
        let {x, y, w, h} = punchArea;
        for (let row = y; row < y+h; row++) {
          for (let col = x; col < x+w; col++) {
            let i = (row * canvas.width + col) * 4;
            let delta = Math.abs(frame.data[i] - lastFrame.data[i]) +
                        Math.abs(frame.data[i+1] - lastFrame.data[i+1]) +
                        Math.abs(frame.data[i+2] - lastFrame.data[i+2]);
            if (delta > 50) diff++;
          }
        }

        // Normalizza in range 1–999
        let score = Math.min(999, Math.floor(diff / 20));
        if (score > 50) { 
          locked = true;
          scoreEl.textContent = "Punteggio: " + score;

          if (score > record) {
            record = score;
            localStorage.setItem('record', record);
            recordEl.textContent = "Record: " + record;
          }
        }
      }
      lastFrame = frame;
      requestAnimationFrame(detectMovement);
    }

    resetBtn.addEventListener('click', () => {
      locked = false;
      scoreEl.textContent = "Punteggio: 0";
    });

    requestAnimationFrame(detectMovement);
  </script>
</body>
</html>
